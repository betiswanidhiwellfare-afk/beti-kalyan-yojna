<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard ‚Äì ‡§¨‡§æ‡§≤ ‡§ú‡•Ä‡§µ‡§® ‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Noto Sans Devanagari","Mangal","Segoe UI",Arial,sans-serif;}
body{background:#f3f6f9;}
.header-title{background:#0b5394;color:#fff;padding:12px;text-align:center;font-size:20px;font-weight:600;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.header-title span{font-weight:600;}
.logout-btn{padding:6px 12px;background:#c62828;color:#fff;border:none;border-radius:4px;cursor:pointer;}
.logout-btn:hover{background:#b71c1c;}
.container{max-width:900px;margin:20px auto;background:#fff;border-radius:6px;box-shadow:0 6px 15px rgba(0,0,0,0.1);padding:20px;}
h2{color:#0b5394;text-align:center;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;}
th, td{border:1px solid #cfd8e3;padding:10px;text-align:center;}
th{background:#0b5394;color:#fff;}
button.approve-btn{padding:6px 12px;background:#2e7d32;color:#fff;border:none;border-radius:4px;cursor:pointer;}
button.approve-btn:hover{background:#1b4d23;}
.status.pending{color:#c62828;font-weight:600;}
.status.activated{color:#2e7d32;font-weight:600;}
</style>
</head>
<body>

<div class="header-title">
    <span>Admin Dashboard ‚Äì ‡§¨‡§æ‡§≤ ‡§ú‡•Ä‡§µ‡§® ‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ</span>
    <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<div class="container">
<h2>‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø‡§£ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡•Ç‡§ö‡•Ä</h2>
<table>
<thead>
<tr>
<th>‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
<th>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</th>
<th>UTR / Transaction ID</th>
<th>‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü</th>
<th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
<th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
</tr>
</thead>
<tbody id="paymentList">
<tr><td colspan="6">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>
</tbody>
</table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAPSLZU2rGmBTjugMGXzLHpznOaRUW3i4k",
  authDomain: "betikalyanyojnaind.firebaseapp.com",
  projectId: "betikalyanyojnaind",
  storageBucket: "betikalyanyojnaind.firebasestorage.app",
  messagingSenderId: "646974816722",
  appId: "1:646974816722:web:6b0c9c8960d1846a8e480b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// üîê Admin check
const isAdmin = localStorage.getItem("adminUser");
if(!isAdmin || isAdmin !== "true"){
    alert("‡§Ü‡§™‡§ï‡•ã ‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à");
    window.location.href = "index.html";
}

// Logout
document.getElementById("logoutBtn").addEventListener("click",()=>{
    localStorage.removeItem("adminUser");
    alert("‡§Ü‡§™ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•ã ‡§ó‡§è ‡§π‡•à‡§Ç");
    window.location.href = "index.html";
});

const paymentList = document.getElementById("paymentList");

// üîÑ REALTIME PAYMENTS
db.collection("payments").orderBy("date","asc").onSnapshot(snapshot=>{
    paymentList.innerHTML = "";

    if(snapshot.empty){
        paymentList.innerHTML = `<tr><td colspan="6">‡§ï‡•ã‡§à ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
        return;
    }

    snapshot.forEach(doc=>{
        const data = doc.data();
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${data.username}</td>
            <td>${data.aadhaar}</td>
            <td>${data.utr}</td>
            <td><a href="${data.screenshot}" target="_blank">‡§¶‡•á‡§ñ‡•á‡§Ç</a></td>
            <td class="status ${data.status.toLowerCase()}">${data.status}</td>
            <td>
                ${data.status==="Pending"
                    ? `<button class="approve-btn" data-id="${doc.id}">Approve</button>`
                    : "‚Äî"}
            </td>
        `;
        paymentList.appendChild(tr);
    });

    // ‚úÖ APPROVE LOGIC
    document.querySelectorAll(".approve-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-id");

            if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")){
                db.collection("payments").doc(id).get().then(docSnap=>{
                    if(!docSnap.exists) return;

                    const data = docSnap.data();
                    const aadhaar = data.aadhaar;

                    // Activate payment
                    db.collection("payments").doc(id).update({
                        status: "Activated",
                        activatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    // Activate user (referral unlock)
                    .then(()=>{
    // Activate the user
   return db.collection("users").doc(aadhaar).update({
    activated: true,
    activationTime: firebase.firestore.FieldValue.serverTimestamp()
});

})
.then(()=>{
    // üîé Check if this user was referred
    return db.collection("users").doc(aadhaar).get();
})
.then(userDoc=>{
    if(!userDoc.exists) return;

    const userData = userDoc.data();
    if(userData.activationProcessed) return;

    const referredBy = userData.referredBy;

    // ‚ùå No referral OR reward already given ‚Üí stop
    if(!referredBy || userData.referralRewardGiven) return;

    // üîç Find referrer by referral code
    return db.collection("users")
        .where("ownReferral","==",referredBy)
        .get()
        .then(snapshot=>{
            if(snapshot.empty) return;

            snapshot.forEach(refDoc=>{
                const refId = refDoc.id;
               db.collection("users").doc(refId).update({
    balance: firebase.firestore.FieldValue.increment(150)
});

            });

            // ‚úÖ Mark THIS USER as reward processed
            return db.collection("users").doc(userDoc.id).update({
                referralRewardGiven: true
            });
        });
})

                 .then(async ()=>{
    // üî• DISTRIBUTE ‚Çπ450 HERE
    await distribute450();

    // üîí LOCK THIS USER FOREVER
    await db.collection("users").doc(aadhaar).update({
        activationProcessed: true
    });

    const statusCell = btn.parentElement.previousElementSibling;
    statusCell.innerText = "Activated";
    statusCell.className = "status activated";
    btn.remove();

    alert("‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à\n‚Çπ600 ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§µ‡§ø‡§§‡§∞‡§ø‡§§ ‡§ï‡§ø‡§è ‡§ó‡§è");
});

                });
            }
        });
    });

}); // ‚úÖ THIS WAS MISSING
async function distribute450(){
    const usersSnap = await db.collection("users")
    .where("activated","==",true)
.orderBy("activationTime")

    .get();

    if(usersSnap.empty) return;

    const users = usersSnap.docs.map(d => ({
        id: d.id,
        ...d.data()
    }));

    const pointerRef = db.collection("system").doc("distribution");
    const pointerSnap = await pointerRef.get();

    let pointer = pointerSnap.exists ? pointerSnap.data().pointer : 0;
    let given = 0;
    let i = pointer;

    while(given < 30){
        const u = users[i % users.length];

        if((u.distributionCount || 0) >= 1000){
            i++;
            continue;
        }

        await db.collection("users").doc(u.id).update({
            balance: firebase.firestore.FieldValue.increment(15),
            distributionCount: firebase.firestore.FieldValue.increment(1)
        });

        given++;
        i++;
    }

    await pointerRef.set({
        pointer: i % users.length
    });
}


</script>

</body>
</html>